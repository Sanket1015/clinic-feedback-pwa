<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#008080">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <title>Clinic Feedback</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- CHART.JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
      /* --- GLOBAL STYLES --- */
      :root { --primary: #008080; --primary-dark: #006666; --bg-body: #f4f7f6; --bg-card: #FFFFFF; --text: #333; --border: #e0e0e0; --gold: #FFD700; --gray-star: #e0e0e0; --success: #28a745; --danger: #dc3545; }
      * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
      body { font-family: 'Poppins', sans-serif; margin: 0; padding: 0; background-color: var(--bg-body); color: var(--text); overflow-x: hidden; min-height: 100vh; }
      .container { max-width: 600px; margin: 20px auto; background: var(--bg-card); min-height: 90vh; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; position: relative; }
      .hidden { display: none !important; }

      /* --- ORIGINAL FORM STYLES (Unchanged logic) --- */
      .header { background: var(--primary); color: white; padding: 25px 20px; text-align: center; position: relative; }
      .header h2 { margin: 0; font-weight: 600; font-size: 22px; }
      .header p { margin: 5px 0 0; font-size: 13px; opacity: 0.9; font-weight: 300; }
      .admin-btn { position: absolute; top: 20px; right: 20px; color: white; opacity: 0.7; cursor: pointer; font-size: 18px; }
      .form-body { padding: 25px; }
      .form-group { margin-bottom: 25px; }
      label { font-weight: 500; font-size: 14px; display: block; margin-bottom: 8px; color: #555; }
      input[type="text"], input[type="date"], input[type="password"], select, textarea { width: 100%; padding: 14px; border: 1px solid var(--border); border-radius: 8px; font-size: 15px; font-family: inherit; background: #fdfdfd; transition: all 0.3s; }
      .uppercase-input { text-transform: uppercase; }
      input:focus, select:focus, textarea:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(0, 128, 128, 0.1); outline: none; }
      .radio-option { display: flex; align-items: center; padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; cursor: pointer; background: #fff; }
      .radio-option input { margin-right: 15px; width: 18px; height: 18px; accent-color: var(--primary); }
      .checkbox-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .follow-up { display: none; margin-top: 12px; padding: 15px; background: #f0fcfc; border-left: 4px solid var(--primary); border-radius: 4px; }
      .follow-up.show { display: block; }
      .stars-wrapper { display: inline-flex; position: relative; height: 45px; align-items: center; }
      .stars-wrapper input { display: none; }
      .star-icon { width: 38px; height: 38px; fill: var(--gray-star); margin-right: 2px; }
      .click-zone { position: absolute; top:0; bottom:0; cursor: pointer; z-index: 10; }
      .z1 { left:0; width:20px; } .z2 { left:20px; width:20px; } .z3 { left:42px; width:20px; } .z4 { left:62px; width:20px; } .z5 { left:84px; width:20px; } .z6 { left:104px; width:20px; } .z7 { left:126px; width:20px; } .z8 { left:146px; width:20px; } .z9 { left:168px; width:20px; } .z10 { left:188px; width:20px; }
      .btn-submit { width: 100%; background: var(--primary); color: white; padding: 16px; border: none; border-radius: 50px; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(0, 128, 128, 0.3); display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 20px; }
      .btn-submit:disabled { background: #999; }
      
      /* --- SUCCESS & SYNC --- */
      #success-view { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; flex-direction: column; align-items: center; justify-content: center; z-index: 100; opacity: 0; transition: opacity 0.4s; }
      .check-circle { width: 80px; height: 80px; background: #e8f5e9; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; color: var(--success); font-size: 40px; }
      #sync-badge { position: absolute; top: 15px; right: 45px; background: #ffa000; color: white; padding: 5px 10px; border-radius: 20px; font-size: 11px; display: none; z-index: 50; }
      .loader { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid white; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      /* --- ADMIN PANEL STYLES --- */
      #admin-app { display: none; background: #f8f9fa; min-height: 100vh; padding-bottom: 60px; }
      .admin-header { background: #333; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
      .admin-header h3 { margin: 0; font-size: 16px; }
      .close-admin { cursor: pointer; font-size: 20px; }
      
      .date-banner { background: #e3f2fd; color: #0d47a1; padding: 8px 15px; font-size: 12px; text-align: center; font-weight: 500; border-bottom: 1px solid #bbdefb; }
      .date-banner u { cursor: pointer; margin-left: 5px; }

      /* Tabs */
      .nav-tabs { display: flex; background: white; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 40; }
      .nav-tab { flex: 1; text-align: center; padding: 12px; font-size: 13px; color: #666; cursor: pointer; border-bottom: 3px solid transparent; }
      .nav-tab.active { border-bottom-color: var(--primary); color: var(--primary); font-weight: 600; }
      
      /* Login Modal */
      #login-modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.8); z-index: 200; display: none; align-items: center; justify-content: center; }
      .login-box { background: white; padding: 30px; border-radius: 12px; width: 85%; max-width: 320px; text-align: center; }
      
      /* Dashboard */
      .dash-grid { padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .kpi-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; }
      .kpi-val { font-size: 24px; font-weight: 700; color: var(--primary); }
      .kpi-lbl { font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 5px; }
      .chart-container { background: white; margin: 15px; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
      .chart-title { font-size: 14px; font-weight: 600; margin-bottom: 15px; color: #444; }

      /* Records Table (Cards) */
      .records-list { padding: 15px; }
      .record-card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.1s; }
      .record-card:active { background: #fafafa; }
      .rc-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
      .rc-id { font-weight: 600; font-size: 14px; }
      .rc-date { font-size: 12px; color: #888; }
      .rc-row { display: flex; justify-content: space-between; align-items: center; }
      .rc-name { font-size: 13px; color: #555; }
      .rc-rating { font-weight: 700; color: var(--gold); font-size: 14px; }
      .rc-details { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; font-size: 13px; color: #444; }
      .rc-details div { margin-bottom: 4px; }
      .rc-label { font-weight: 500; color: #000; }
      
      /* Filter Drawer */
      #filter-drawer { position: fixed; top: 0; right: -100%; width: 85%; height: 100%; background: white; z-index: 150; transition: right 0.3s; padding: 20px; box-shadow: -5px 0 15px rgba(0,0,0,0.1); overflow-y: auto; }
      #filter-drawer.open { right: 0; }
      .drawer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
      .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.3); z-index: 140; display: none; }
      .fab-filter { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-size: 20px; cursor: pointer; z-index: 100; }
    </style>
  </head>
  <body>
    <svg style="display:none;"><symbol id="icon-star" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></symbol><symbol id="icon-star-half" viewBox="0 0 24 24"><path d="M22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" fill="#D3D3D3"/><path d="M12 2l-2.81 6.63L2 9.24l5.46 4.73L5.82 21 12 17.27V2z" /></symbol></svg>

    <div class="container">
      
      <!-- ================= PATIENT FEEDBACK APP (EXISTING) ================= -->
      <div id="patient-view">
        <div id="sync-badge"><i class="fas fa-sync fa-spin"></i> Syncing...</div>
        <div id="success-view">
          <div class="success-content"><div class="check-circle"><i class="fas fa-check"></i></div><div class="success-title">Feedback Saved</div><div class="success-sub">Thank you for your valuable input.</div><p style="font-size:12px; color:#999;">Form will refresh automatically...</p></div>
        </div>

        <div id="main-view">
          <div class="header">
            <h2>Clinic Feedback</h2><p>We value your input</p>
            <div class="admin-btn" onclick="openAdmin()"><i class="fas fa-lock"></i></div>
          </div>
          <div class="form-body">
            <form id="feedbackForm" autocomplete="off">
              <div class="form-group"><label>1. Case Number / ID *</label><input type="text" name="caseNumber" id="caseInput" required placeholder="Enter ID" autocomplete="off" class="uppercase-input" oninput="this.value = this.value.toUpperCase()"></div>
              <div class="form-group"><label>1. Name of Patient *</label><input type="text" name="patientName" required placeholder="Full Name" autocomplete="off"></div>
              <div class="form-group"><label>2. Date of Visit *</label><input type="date" name="visitDate" id="dateField" required></div>
              <div class="form-group"><label>3. Disease Department</label><select name="department"><option value="" disabled selected>Select Department</option><option>Cardiology</option><option>Dermatology</option><option>E.N.T</option><option>Endocrinology & Metabolic Disorder</option><option>Gastroenterology</option><option>General / Systemic Disease</option><option>Gynaecology & Obstetrics</option><option>Haematology</option><option>Infectious Diseases</option><option>Male Reproductive System Pathology</option><option>Nephrology</option><option>Neurology</option><option>Oncology</option><option>Ophthalmology</option><option>Oral Pathology</option><option>Ortho and Muscular Disorder</option><option>Psychiatry</option><option>Pulmonology</option><option>Sexual Complain</option><option>Urology</option><option>Vascular Medicine</option><option>Other</option></select></div>
              <div class="form-group"><label>4. Behaviour of Employees *</label><label class="radio-option"><input type="radio" name="empBehaviour" value="Excellent" required> Excellent</label><label class="radio-option"><input type="radio" name="empBehaviour" value="Good"> Good</label><label class="radio-option"><input type="radio" name="empBehaviour" value="Average"> Average</label><label class="radio-option"><input type="radio" name="empBehaviour" value="Poor"> Poor</label><div id="followBehaviour" class="follow-up"><label>Please let us know what can be improved</label><textarea name="empComments" rows="3"></textarea></div></div>
              <div class="form-group"><label>5. Was the doctor polite and clear? *</label><label class="radio-option"><input type="radio" name="docPolite" value="Yes" required> Yes</label><label class="radio-option"><input type="radio" name="docPolite" value="No"> No</label><div id="followDoc" class="follow-up"><label>Comments</label><textarea name="docComments" rows="2"></textarea></div></div>
              <div class="form-group"><label>6. Was booking process easy and smooth? *</label><label class="radio-option"><input type="radio" name="bookingSmooth" value="Yes" required> Yes</label><label class="radio-option"><input type="radio" name="bookingSmooth" value="No"> No</label><div id="followBooking" class="follow-up"><label>Comments</label><textarea name="bookingComments" rows="2"></textarea></div></div>
              <div class="form-group"><label>7. Was the clinic clean and hygienic? *</label><label class="radio-option"><input type="radio" name="clinicClean" value="Yes" required> Yes</label><label class="radio-option"><input type="radio" name="clinicClean" value="No"> No</label><div id="followClean" class="follow-up"><label>Comments</label><textarea name="cleanComments" rows="2"></textarea></div></div>
              <div class="form-group"><label>8. How did you come to know about us? *</label><div class="checkbox-grid"><label class="radio-option"><input type="checkbox" name="source" value="Reference"> Reference</label><label class="radio-option"><input type="checkbox" name="source" value="Facebook"> Facebook</label><label class="radio-option"><input type="checkbox" name="source" value="Youtube"> Youtube</label><label class="radio-option"><input type="checkbox" name="source" value="Website"> Website</label></div></div>
              <div class="form-group"><label>9. Overall rating * <span id="rating-val" style="color:var(--primary); font-weight:bold; margin-left:10px;">0.0</span></label><div class="stars-wrapper"><svg class="star-icon" id="s1"><use href="#icon-star"></use></svg><svg class="star-icon" id="s2"><use href="#icon-star"></use></svg><svg class="star-icon" id="s3"><use href="#icon-star"></use></svg><svg class="star-icon" id="s4"><use href="#icon-star"></use></svg><svg class="star-icon" id="s5"><use href="#icon-star"></use></svg><label class="click-zone z1" for="r0.5"></label><input type="radio" name="rating" id="r0.5" value="0.5"><label class="click-zone z2" for="r1.0"></label><input type="radio" name="rating" id="r1.0" value="1.0"><label class="click-zone z3" for="r1.5"></label><input type="radio" name="rating" id="r1.5" value="1.5"><label class="click-zone z4" for="r2.0"></label><input type="radio" name="rating" id="r2.0" value="2.0"><label class="click-zone z5" for="r2.5"></label><input type="radio" name="rating" id="r2.5" value="2.5"><label class="click-zone z6" for="r3.0"></label><input type="radio" name="rating" id="r3.0" value="3.0"><label class="click-zone z7" for="r3.5"></label><input type="radio" name="rating" id="r3.5" value="3.5"><label class="click-zone z8" for="r4.0"></label><input type="radio" name="rating" id="r4.0" value="4.0"><label class="click-zone z9" for="r4.5"></label><input type="radio" name="rating" id="r4.5" value="4.5"><label class="click-zone z10" for="r5.0"></label><input type="radio" name="rating" id="r5.0" value="5.0"></div></div>
              <div class="form-group"><label>10. General Suggestion</label><textarea name="suggestion" rows="3"></textarea></div>
              <div class="form-group"><label style="font-size:13px; color:#666;">11. Feedback taken by *</label><select name="feedbackBy" required><option>RAJA</option></select></div>
              <div class="action-area"><button type="submit" id="submitBtn" class="btn-submit"><span id="btnText">SUBMIT FEEDBACK</span><div id="btnLoader" class="loader"></div></button></div>
            </form>
          </div>
        </div>
      </div>

      <!-- ================= ADMIN DASHBOARD (NEW) ================= -->
      <div id="admin-app">
        <div class="admin-header">
          <h3>Admin Dashboard</h3>
          <i class="fas fa-times close-admin" onclick="closeAdmin()"></i>
        </div>
        
        <div id="date-status" class="date-banner">
          ðŸ“… Showing: <span id="date-range-lbl">Last 30 Days</span> <u onclick="openFilter()">Change</u>
        </div>

        <div class="nav-tabs">
          <div class="nav-tab active" onclick="switchTab('dash')">Overview</div>
          <div class="nav-tab" onclick="switchTab('records')">Records</div>
          <div class="nav-tab" onclick="switchTab('settings')">Settings</div>
        </div>

        <!-- TAB 1: DASHBOARD -->
        <div id="tab-dash" class="tab-content">
          <div class="dash-grid">
            <div class="kpi-card"><div class="kpi-val" id="kpi-total">0</div><div class="kpi-lbl">Feedback</div></div>
            <div class="kpi-card"><div class="kpi-val" id="kpi-csi">0%</div><div class="kpi-lbl">Satisfaction</div></div>
          </div>
          
          <div class="chart-container">
            <div class="chart-title">Rating Trend</div>
            <canvas id="chartTrend"></canvas>
          </div>

          <div class="chart-container">
            <div class="chart-title">Operational Metrics (Yes vs No)</div>
            <canvas id="chartOps"></canvas>
          </div>

          <div class="chart-container">
            <div class="chart-title">Employee Behaviour</div>
            <canvas id="chartEmp"></canvas>
          </div>

          <div class="chart-container">
            <div class="chart-title">Marketing Source</div>
            <canvas id="chartSource"></canvas>
          </div>
        </div>

        <!-- TAB 2: RECORDS -->
        <div id="tab-records" class="tab-content hidden">
          <div id="records-container" class="records-list"></div>
          <div style="text-align:center; padding:20px; color:#999; font-size:12px;">
            End of loaded records.<br>Use "Change" above to search older dates.
          </div>
          <div class="fab-filter" onclick="openFilter()"><i class="fas fa-filter"></i></div>
        </div>

        <!-- TAB 3: SETTINGS -->
        <div id="tab-settings" class="tab-content hidden" style="padding:20px;">
          <h4 style="margin-top:0;">Security</h4>
          <div class="form-group">
            <label>Old Password</label><input type="password" id="oldPass">
          </div>
          <div class="form-group">
            <label>New Password</label><input type="password" id="newPass">
          </div>
          <button class="btn-submit" onclick="changePassword()" style="margin-bottom:30px;">Update Password</button>
          
          <button class="btn-submit" onclick="logout()" style="background:#666;">Logout</button>
        </div>
      </div>

      <!-- FILTER DRAWER -->
      <div class="overlay" id="drawer-overlay" onclick="closeFilter()"></div>
      <div id="filter-drawer">
        <div class="drawer-header"><h3>Filter Data</h3><i class="fas fa-times" onclick="closeFilter()"></i></div>
        
        <div class="form-group">
          <label>Date Range (Server Load)</label>
          <div style="display:flex; gap:10px;">
            <input type="date" id="filter-start">
            <input type="date" id="filter-end">
          </div>
          <small style="color:#primary; display:block; margin-top:5px;">Changing dates triggers a reload.</small>
        </div>

        <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
        
        <div class="form-group"><label>Department</label><select id="filter-dept"><option value="All">All Departments</option><option>Cardiology</option><option>Dermatology</option><option>E.N.T</option><option>Gynaecology & Obstetrics</option><option>Ortho and Muscular Disorder</option><option>Other</option></select></div>
        <div class="form-group"><label>Rating</label><select id="filter-rating"><option value="All">All Ratings</option><option value="Low">Low (< 3)</option><option value="High">High (4+)</option></select></div>

        <button class="btn-submit" onclick="applyFilter()">Apply Filters</button>
      </div>

      <!-- LOGIN MODAL -->
      <div id="login-modal">
        <div class="login-box">
          <h3>Admin Login</h3>
          <div class="form-group"><input type="password" id="adminPass" placeholder="Enter Password" style="text-align:center; letter-spacing:5px;"></div>
          <button class="btn-submit" id="btnLogin" onclick="attemptLogin()">ENTER</button>
          <div id="login-msg" style="color:red; font-size:12px; margin-top:10px;"></div>
          <button style="margin-top:15px; background:none; border:none; color:#999; text-decoration:underline;" onclick="closeAdmin()">Cancel</button>
        </div>
      </div>

    </div>

    <script>
      // ================= CONFIGURATION =================
      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbygybhNtcr494gmONIONCYcx9f1og2uOoH29VJI2lIJUCKsYUblIws2O9MPNtmabPaV/exec"; 

      // ================= EXISTING APP LOGIC (UNCHANGED) =================
      if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js'); }); }
      document.getElementById('dateField').valueAsDate = new Date();
      const starInputs = document.querySelectorAll('input[name="rating"]');
      const starIcons = [document.getElementById('s1'),document.getElementById('s2'),document.getElementById('s3'),document.getElementById('s4'),document.getElementById('s5')];
      const ratingVal = document.getElementById('rating-val');
      starInputs.forEach(input => { input.addEventListener('change', function() { const val = parseFloat(this.value); ratingVal.innerText = val.toFixed(1); updateStars(val); }); });
      function updateStars(val) { starIcons.forEach((icon, index) => { const num = index + 1; icon.style.fill = 'var(--gray-star)'; icon.innerHTML = '<use href="#icon-star"></use>'; if (val >= num) icon.style.fill = 'var(--gold)'; else if (val >= num - 0.5) { icon.style.fill = 'var(--gold)'; icon.innerHTML = '<use href="#icon-star-half"></use>'; } }); }
      function setupLogic(name, divId, val, isBeh) { document.getElementsByName(name).forEach(el => { el.addEventListener('change', () => { const div = document.getElementById(divId); let s = false; if(isBeh) { if(el.value==='Average'||el.value==='Poor') s=true; } else { if(el.value===val) s=true; } if(s) div.classList.add('show'); else div.classList.remove('show'); }); }); }
      setupLogic('empBehaviour','followBehaviour','',true); setupLogic('docPolite','followDoc','No'); setupLogic('bookingSmooth','followBooking','No'); setupLogic('clinicClean','followClean','No');
      
      const form = document.getElementById('feedbackForm');
      form.addEventListener('submit', e => { e.preventDefault(); setLoading(true); const fd = new FormData(form); let obj = {}; fd.forEach((v,k) => { obj[k] = obj[k] ? obj[k] + ", " + v : v; }); if(navigator.onLine) { sendData(obj); } else { saveOffline(obj); } });
      function sendData(data) { fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) }).then(res => res.json()).then(resData => { if(resData.result === 'success') triggerSuccessAnimation("Feedback Saved"); else { alert("Error: " + resData.error); setLoading(false); } }).catch(err => { saveOffline(data); }); }
      function saveOffline(data) { let q = JSON.parse(localStorage.getItem('clinicDB') || "[]"); data._savedAt = new Date(); q.push(data); localStorage.setItem('clinicDB', JSON.stringify(q)); triggerSuccessAnimation("Saved to Device (Offline)"); }
      function setLoading(isLoading) { const btn = document.getElementById('submitBtn'); const txt = document.getElementById('btnText'); const ldr = document.getElementById('btnLoader'); if(isLoading) { btn.disabled = true; txt.innerText = "SAVING..."; ldr.style.display = "block"; } else { btn.disabled = false; txt.innerText = "SUBMIT FEEDBACK"; ldr.style.display = "none"; } }
      function triggerSuccessAnimation(msg) { document.querySelector('.success-title').innerText = msg; document.getElementById('main-view').style.display = 'none'; document.getElementById('success-view').style.display = 'flex'; setTimeout(() => { document.getElementById('success-view').style.opacity = '1'; }, 10); window.scrollTo(0,0); setTimeout(() => { resetAll(); }, 2500); }
      function resetAll() { document.getElementById('success-view').style.opacity = '0'; setTimeout(() => { document.getElementById('success-view').style.display = 'none'; document.getElementById('main-view').style.display = 'block'; form.reset(); document.getElementById('dateField').valueAsDate = new Date(); updateStars(0); ratingVal.innerText = "0.0"; document.querySelectorAll('.follow-up').forEach(x => x.classList.remove('show')); setLoading(false); setTimeout(() => { document.getElementById('caseInput').focus(); }, 100); }, 400); }

      // ================= NEW ADMIN LOGIC =================
      let RAW_DATA = [];
      let chartInstances = {};

      function openAdmin() {
        if(localStorage.getItem('isAdmin') === 'true') {
          showDashboard();
        } else {
          document.getElementById('login-modal').style.display = 'flex';
          document.getElementById('adminPass').focus();
        }
      }

      function closeAdmin() {
        document.getElementById('login-modal').style.display = 'none';
        document.getElementById('admin-app').style.display = 'none';
        document.getElementById('patient-view').style.display = 'block';
        window.scrollTo(0,0);
      }

      function attemptLogin() {
        const p = document.getElementById('adminPass').value;
        const btn = document.getElementById('btnLogin');
        const msg = document.getElementById('login-msg');
        
        btn.innerText = "Checking...";
        msg.innerText = "";
        
        fetch(SCRIPT_URL + `?action=login&pass=${p}`)
        .then(r => r.json())
        .then(d => {
          if(d.result === 'success') {
            localStorage.setItem('isAdmin', 'true');
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('adminPass').value = "";
            showDashboard();
          } else {
            msg.innerText = "Incorrect Password";
          }
          btn.innerText = "ENTER";
        })
        .catch(e => { msg.innerText = "Network Error"; btn.innerText = "ENTER"; });
      }

      function logout() {
        localStorage.removeItem('isAdmin');
        closeAdmin();
      }

      function showDashboard() {
        document.getElementById('patient-view').style.display = 'none';
        document.getElementById('admin-app').style.display = 'block';
        loadData(); // Default load (Last 30 Days)
      }

      function loadData(startStr, endStr) {
        // Build URL
        let url = SCRIPT_URL + `?action=getData`;
        if(startStr && endStr) {
          url += `&start=${startStr}&end=${endStr}`;
          document.getElementById('date-range-lbl').innerText = `${startStr} to ${endStr}`;
        } else {
          document.getElementById('date-range-lbl').innerText = "Last 30 Days";
          // Set inputs to default
          const today = new Date();
          const past = new Date(); past.setDate(today.getDate()-30);
          document.getElementById('filter-end').valueAsDate = today;
          document.getElementById('filter-start').valueAsDate = past;
        }

        fetch(url).then(r=>r.json()).then(d => {
          if(d.result === 'success') {
            RAW_DATA = d.data;
            processData(RAW_DATA);
          } else {
            alert("Error loading data");
          }
        });
      }

      function processData(data) {
        // 1. Calculate KPIs
        document.getElementById('kpi-total').innerText = data.length;
        const avg = data.reduce((acc, r) => acc + (parseFloat(r['Rating'])||0), 0) / (data.length||1);
        document.getElementById('kpi-csi').innerText = Math.round((avg/5)*100) + "%";
        
        // 2. Render Charts
        renderCharts(data);
        
        // 3. Render List
        renderList(data);
      }

      function renderList(data) {
        const c = document.getElementById('records-container');
        c.innerHTML = "";
        data.forEach(r => {
          let dateTxt = "N/A";
          if(r['Visit Date']) dateTxt = new Date(r['Visit Date']).toLocaleDateString();
          else if(r['Timestamp']) dateTxt = new Date(r['Timestamp']).toLocaleDateString();

          const card = document.createElement('div');
          card.className = "record-card";
          card.innerHTML = `
            <div class="rc-header"><span class="rc-id">${r['Case Number']}</span><span class="rc-date">${dateTxt}</span></div>
            <div class="rc-row"><span class="rc-name">${r['Patient Name']}</span><span class="rc-rating">${r['Rating']} â˜…</span></div>
            <div class="rc-details">
              <div><span class="rc-label">Dept:</span> ${r['Department']}</div>
              <div><span class="rc-label">Doc Polite:</span> ${r['Doctor Polite']} ${r['Doctor Comments'] ? '('+r['Doctor Comments']+')' : ''}</div>
              <div><span class="rc-label">Clean:</span> ${r['Clinic Clean']}</div>
            </div>
          `;
          card.onclick = function() {
            const det = this.querySelector('.rc-details');
            det.style.display = det.style.display==='block' ? 'none' : 'block';
          };
          c.appendChild(card);
        });
      }

      // --- FILTER LOGIC ---
      function openFilter() { 
        document.getElementById('drawer-overlay').style.display = 'block';
        setTimeout(()=>document.getElementById('filter-drawer').classList.add('open'), 10);
      }
      function closeFilter() {
        document.getElementById('filter-drawer').classList.remove('open');
        setTimeout(()=>document.getElementById('drawer-overlay').style.display = 'none', 300);
      }
      function applyFilter() {
        const start = document.getElementById('filter-start').value;
        const end = document.getElementById('filter-end').value;
        const dept = document.getElementById('filter-dept').value;
        const rate = document.getElementById('filter-rating').value;

        // If dates changed, reload from server
        // Logic: if user explicitly sets dates, reload. For simple client side filter, just filter.
        // For simplicity: We reload if dates are present.
        if(start && end) {
          loadData(start, end); // Fetch new chunk
          // Client side filter happens after fetch in real world, but here we keep it simple
          // Wait for fetch? Actually, let's just do client side filtering on the CURRENT RAW_DATA for Dept/Rating
          // To be robust: If dates changed, we fetch. Then we filter locally.
          // Let's reload fetch only if we pressed the button.
        }

        // Apply Local Filter on RAW_DATA
        let local = RAW_DATA.filter(r => {
          let ok = true;
          if(dept !== 'All' && r['Department'] !== dept) ok = false;
          if(rate === 'Low' && parseFloat(r['Rating']) >= 3) ok = false;
          if(rate === 'High' && parseFloat(r['Rating']) < 4) ok = false;
          return ok;
        });
        
        renderList(local);
        closeFilter();
      }

      function changePassword() {
        const o = document.getElementById('oldPass').value;
        const n = document.getElementById('newPass').value;
        fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({action:'changePassword', oldPass:o, newPass:n})
        })
        .then(r=>r.json())
        .then(d=>{
          if(d.result==='success') { alert("Password Changed"); document.getElementById('oldPass').value=""; document.getElementById('newPass').value=""; }
          else alert("Error: " + d.error);
        });
      }

      function switchTab(t) {
        document.querySelectorAll('.tab-content').forEach(d => d.classList.add('hidden'));
        document.querySelectorAll('.nav-tab').forEach(d => d.classList.remove('active'));
        document.getElementById('tab-'+t).classList.remove('hidden');
        event.target.classList.add('active');
      }

      // --- CHART LOGIC ---
      function renderCharts(data) {
        // Destroy old charts
        ['chartTrend','chartOps','chartEmp','chartSource'].forEach(id => {
          if(chartInstances[id]) chartInstances[id].destroy();
        });

        // 1. Trend (Line) - Group by Date
        const dates = {};
        data.forEach(r => {
          let d = r['Visit Date'] ? r['Visit Date'].substring(0,10) : 'Unknown';
          if(!dates[d]) dates[d] = [];
          dates[d].push(parseFloat(r['Rating'])||0);
        });
        const lbls = Object.keys(dates).sort();
        const avgs = lbls.map(d => dates[d].reduce((a,b)=>a+b,0)/dates[d].length);
        
        chartInstances['chartTrend'] = new Chart(document.getElementById('chartTrend'), {
          type: 'line',
          data: { labels: lbls, datasets: [{ label: 'Avg Rating', data: avgs, borderColor: '#008080', tension: 0.3 }] }
        });

        // 2. Source (Bar)
        const srcs = {};
        data.forEach(r => {
          // Source is comma separated usually if checkbox
          let s = r['Source'] || 'Unknown';
          s.split(',').forEach(x => { x=x.trim(); srcs[x] = (srcs[x]||0)+1; });
        });
        chartInstances['chartSource'] = new Chart(document.getElementById('chartSource'), {
          type: 'bar',
          data: { labels: Object.keys(srcs), datasets: [{ label: 'Count', data: Object.values(srcs), backgroundColor: '#FFD700' }] }
        });

        // 3. Employee (Doughnut)
        const emps = { 'Excellent':0, 'Good':0, 'Average':0, 'Poor':0 };
        data.forEach(r => { if(emps[r['Emp Behaviour']] !== undefined) emps[r['Emp Behaviour']]++; });
        chartInstances['chartEmp'] = new Chart(document.getElementById('chartEmp'), {
          type: 'doughnut',
          data: { labels: Object.keys(emps), datasets: [{ data: Object.values(emps), backgroundColor: ['#28a745','#17a2b8','#fd7e14','#dc3545'] }] }
        });

        // 4. Ops (Stacked Bar - Yes/No)
        const ops = {
          'Doctor Polite': {Yes:0, No:0},
          'Booking Smooth': {Yes:0, No:0},
          'Clinic Clean': {Yes:0, No:0}
        };
        data.forEach(r => {
          ['Doctor Polite','Booking Smooth','Clinic Clean'].forEach(k => {
            let val = r[k] === 'Yes' ? 'Yes' : 'No';
            ops[k][val]++;
          });
        });
        chartInstances['chartOps'] = new Chart(document.getElementById('chartOps'), {
          type: 'bar',
          data: {
            labels: ['Doctor', 'Booking', 'Cleanliness'],
            datasets: [
              { label: 'Yes', data: [ops['Doctor Polite'].Yes, ops['Booking Smooth'].Yes, ops['Clinic Clean'].Yes], backgroundColor: '#28a745' },
              { label: 'No', data: [ops['Doctor Polite'].No, ops['Booking Smooth'].No, ops['Clinic Clean'].No], backgroundColor: '#dc3545' }
            ]
          },
          options: { scales: { x: { stacked: true }, y: { stacked: true } } }
        });
      }
    </script>
  </body>
</html>